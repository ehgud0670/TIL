# chapter 1  
# 자바 8, 8, 10, 11 : 무슨 일이 일어나고 있는가?

* 자바 8 이전

```java
Collections.sort(inventory, new Comparator<Apple>() {
    public int compare(Apple a1 , Apple a2){
        return a1.getWeight().compareTo(a2.getWeight());
    }
});
```
이 코드를 , 

* 자바 8 이후

```java
inventory.sort(comparing(Apple::getWeight)); // 이 책에 등장한 첫번째 자바8 코드
// 더 자연어에 가깝고 간단한 방식 
```
으로 바꿀 수 있다. 

## 1. 자바의 멀티코어 병렬성

> 자바 8 이전의 대부분의 자바 프로그램

=> CPU 코어 중 하나만을 사용했다. 즉, 나머지 코어는 유휴 idle 상태(놀고 있는 상태) 로 두거나, 운영체제나 바이러스 검사 프로그램과 프로세스 파워를 나눠서 사용했다.

* 자바 8 이전에 나머지 코어를 활용하려면 스레드를 사용하라고 조언. 

=> but ! 스레드를 사용하면 **관리하기 어렵고 많은 문제가 발생할 수 있다는 단점.**<br>이를 극복하려 여러가지 움직임이 있었음.<br>자바 1.0에서는 **스레드와 락(lock), 메모리 모델** 까지 지원했지만 전문가가 아니면 이 정도의 저수준 기능을 온전히 사용하기 어려움.
<br>자바 5 에서는 **스레드 풀, 병렬 실행 컬렉션** 등 아주 강력한 도구 도입, 자바 7에서는 병렬 실행에 도움을 줄 수 있는 **포크(fork)/조인(join) 프레임워크**를 제공했지만 여전히 병렬 실행은 개발자에게 쉽지 않은 일.
<br>하지만 자바 8은 몇가지 규칙만 지키면 병렬 실행을 새롭고 단순한 방식으로 접근할 수 있는 방법을 제공한다. 

## => 자바 8은 지금까지 다루기 어려웠던 병렬 실행을 새롭고 단순한 방식으로 접근할 수 있는 방법을 제공한다. 단 , 몇 가지 규칙만 지키기만 한다면!

## 1.1 자바 8 : 간결한 코드 + 멀티코어 프로세서의 쉬운 활용

* 스트림 API
* 메서드에 코드를 전달하는 기법
* 인터페이스의 디폴드 메서드

> 스트림 API 

자바 8은 **데이터베이스 query 언어에서 정규 표현식**을 처리하는 것처럼 병렬 연산을 지원하는 스트림이라는 새로운 API를 지원한다. 

DB query 언어에서 정규 표현식 사용 예 (Oracle DB)
```sql
SELECT first_name , last_name 
FROM employees
WHERE REGEXP_LIKE (first_name , '^Ste(v|ph)en$');
// query 결과
// FIRST_NAME  LAST_NAME
// ----------  ---------
// Steven      King
// Steven      Markle
// Stephen     Stilies

// Meta Characters
// ^ 는 문자열이 나 행의 처음을 의미한다.
// $ 는 문자열이나 행의 끝을 의미한다.
// () 는 여러식을 하나로 묶을 수 있는 기능이다. ex : abc | adc = a(b|d)c 
// | 는 여러 식 중에 하나를 선택하는 기능이다. ex : v | ph 이면 v 나 ph 중 하나 선택.
```

DB Query 언어**처럼** 고수준 언어로 원하는 동작을 표현하면 , 구현(자바에서는 스트림 라이브러리가 이 역할을 수행)에서 **최적의 저수준 실행 방법을 선택하는 방식으로 동작**한다.

=> 다른 식으로 얘기하면 , 스트림 API 덕분에 다른 두 가지 기능, **(1) 메서드에 코드를 전달하는 간결 기법( 메소드 참조와 람다 )** 과 **(2)인터페이스의 디폴트 메서드**가 존재할 수 있음을 알 수 있다.

> 동작 파라미터화

* 메서드의 코드를 전달하는 방법을 이용하면 새롭고 간결한 방식으로 **동작 파라미터화(behavior parameterization)** 를 구현할 수 있다. 예를 들어 약간만 다른 두 메서드가 있다고 가정하자. 이때 두 메서드를 그대로 유지하는 것보다는 인수를 이용해서 다른 동작을 하도록 하나의 메서드로 합치는 것이 바람직할 수 있다. (예를 들어 오름차순, 내림차순 관련된 메서드들이 비슷할 수 있다.) 이 방법은 복사 및 붙여넣는 방식보다 코드가 더 짧고 간결해지며, 불필요한 에러도 줄일 수 있다.


* 자바 8 이전에도 익명 클래스를 이용해 동작 파라미터화를 구현할 수 있겠다 생각하겠지만 , **자바 8이 훨씬 간단명료하다.**

> 함수형 프로그래밍(functional-style programming)

* 자바 8 기법은 **함수형 프로그래밍에서 위력을 발휘**한다.


## 2. 코드를 메서드로 전달하는 기법이 어떻게 강력한 새로운 프로그래밍 도구가 될 수 있는가 

* 자바 8에서는 병렬성을 활용하는 코드, 간결한 코드를 구현할 수 있도록 3가지 기능 즉 스트림 처리 기능, 코드 일부를 API로 전달하는 기능, 공유되지 않은 가변 데이터와 메서드를 다른 메서드로 전달하는 기능을 제공한다.  

### 2.1 스트림 처리 

* 스트림(stream)이란 한 번에 한 개씩 만들어지는 연속적인 데이터 항목들의 모임이다. 

스트림과 관련된 유닉스 명령
```
cat file1 file2 | tr "[A-Z]" "[a-z]" | sort | tail-3
```


스트림 API의 핵심은 기존에는 한 번에 한 항목을 처리했지만 이제 자바 8에서는 우리가 하려는 작업을 ( DB query 처럼 ) 고수준으로 추상화해서 **일련의 스트림(즉 여러개)으로 만들어 처리할 수 있다는 것**이다.
<br>또한 스트림 파이프라인을 이용해서 입력 부분을 여러 CPU 코어에 쉽게 할당할 수 있다는 부가적인 이득도 얻을 수 있고 , **스레드라는 복잡한 작업을 사용하지 않으면서도 공짜로 병렬성을 얻을 수 있다.**

### 2.2 동작 파라미터화로 메서드에 코드 전달하기 

* 코드 일부를 API에 전달하는 기능 

예시 : 송장 ID
```
2013UK0001, 2014US0002 
// 연도 + 국가 코드 + 고객ID
// 2013 , UK , 0001
```
이와 같은 송장 ID들이 있고 sort 한다고 가정해보자. sort 명령을 이용하려면 sort 가 고객ID 나 국가 코드로 송장 ID 를 정렬하도록 sort에 따로 코드를 제공해야 한다. 
예를 들어 sort에 따로 코드를 제공하는 메서드를 고객 ID로 Sort 하는 compareUsingCustomerId()라고 구현할 수 있다.

```java
public int compareUsingCustomerId(String inv1, String inv2){
    //생략
}
```
=> 하지만 자바 8 이전의 자바에서는 이 메서드를 sort()에 전달할 방법이 없었다. (다른 언어에는 있나보다.) Comparator 객체를 만들어서 sort에 넘겨주는 방법도 있지만 이는 너무 복잡하고 기존 코드를 단순하게 재활용하는 측면에서도 맞지 않다.(우리 코드가 아니고 Comparator를 쓰는 것이므로) <br>하지만 **자바8에서는 우리가 구현한 메서드를 다른 메서드의 인수로 넘겨주는 기능을 제공**한다. 이 기능을 이론적으로 **동작 파라미터화**라고 한다.

> 동작 파라미터화가 중요한 이유 ? 

* 스트림 API는 연산의 동작을 파라미터화할 수 있는 코드를 전달한다는 사상에 기초하기 때문. 

### 2.3 병렬성과 공유 가변 데이터

이 기능은 '병렬성을 공짜로 얻을 수 있다'는 말에서 시작하는데 , 공짜로 얻을 수 있는 대신 **스트림 메서드로 전달하는 코드의 동작 방식**을 조금 바꿔야 한다. 

> 안전하게 실행

스트림 메서드로 전달하는 코드는 다른 코드와 **동시에 실행**하더라도 안전하게 실행되어야 하는데 그러려면, 코드가 **공유된 가변 데이터에 접근하면 안된다**
(이러한 함수를 순수함수, 부작용 없는 함수, 상태 없는 함수라 부른다). 
따라서 공유된 변수나 객체가 있으면 병렬성에 문제가 발생하는데 자바 8 이전에는 synchronized를 사용해 해결했다.

> synchronized의 단점 

자바 스레드 API의 기능으로 이 예약어(synchronized : 동기화)로 공유된 가변 데이터를 보호하는 규칙을 만들 수 있다. 하지만 시스템 성능에 악영향을 끼칠 수 있는 코드다. 그리고 다중 프로세싱 코어에서 synchronized 을 사용하면 다중 처리 환경인데도 **코드를 순차적으로 실행하여야 하므로 병렬이라는 목적을 무력화시키기 때문에 적절하지 않다.** 

> 자바 8 스트림의 등장

공유되지 않은 가변 데이터, 메서드

자바 8 스트림을 이용하면 기존의 방법보다 쉽게 **병렬성**을 활용할 수 있다. 즉 synchronized 때문에 성능에 악영향 줄 필요가 없다는 뜻이다!
